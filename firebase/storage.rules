rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    
    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isSignedIn() && 
        firestore.get(/databases/(default)/documents/roles/$(request.auth.uid)).data.role in ['super_admin', 'admin'];
    }
    
    // Profile photos
    match /members/{memberId}/profile/{fileName} {
      allow read: if true; // Public read
      allow write: if isAdmin();
    }
    
    // Registration photos
    match /camps/{campId}/registrations/{registrationId}/{fileName} {
      allow read: if isSignedIn();
      allow write: if true; // Allow uploads during registration
    }
    
    // ID Cards
    match /camps/{campId}/id_cards/{fileName} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Devotional images
    match /camps/{campId}/devotionals/{devotionalId}/{fileName} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Game photos
    match /camps/{campId}/games/{gameId}/{fileName} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Admin uploads
    match /admin/{path=**} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }
  }
}
